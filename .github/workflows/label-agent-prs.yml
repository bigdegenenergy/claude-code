name: Label Agent PRs

on:
  pull_request:
    # SECURITY: Removed 'edited' to prevent potential comment spam
    # when PR descriptions are updated repeatedly
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:  # Allow manual re-runs

jobs:
  label:
    # Skip bot actors and draft PRs
    if: |
      github.event.pull_request.draft == false &&
      !contains(github.actor, '[bot]')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Detect and label AI agent PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const title = pr.title || '';
            const branch = pr.head.ref || '';

            // Patterns that indicate AI agent involvement
            const agentPatterns = [
              /claude/i,
              /\bai\b/i,
              /automated/i,
              /generated/i,
              /copilot/i,
              /gpt/i
            ];

            const isAgentPR = agentPatterns.some(pattern =>
              pattern.test(title) || pattern.test(body) || pattern.test(branch)
            );

            if (isAgentPR) {
              // Add label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['ai-generated', 'needs-human-review']
              });

              // Check if repo-reading checkbox is checked
              const hasReadRepo = body.includes('[x] I have read https://github.com/bigdegenenergy/claude-code');

              if (!hasReadRepo) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `⚠️ **Reminder:** The source repository reading checkbox is not checked.

            Please ensure you have read **https://github.com/bigdegenenergy/claude-code** in full before proceeding.

            Update the PR description to check the box:
            \`\`\`
            - [x] I have read https://github.com/bigdegenenergy/claude-code before creating this PR
            \`\`\``
                });
              }
            }
