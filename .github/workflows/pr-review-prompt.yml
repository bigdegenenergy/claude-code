name: Post Claude Code Prompt

on:
  workflow_run:
    workflows: ["Gemini PR Review"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  post_prompt:
    name: Post Claude Code Integration Prompt
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      - name: Get PR details from workflow run
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // Get the workflow run to find associated PR
            const runId = context.payload.workflow_run.id;
            const headBranch = context.payload.workflow_run.head_branch;

            // Use head_repository owner to support PRs from forks
            const headOwner = context.payload.workflow_run.head_repository?.owner?.login || context.repo.owner;

            // List pull requests associated with this workflow run
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${headOwner}:${headBranch}`
            });

            if (prs.length === 0) {
              console.log(`No open PR found for ${headOwner}:${headBranch}`);
              core.setOutput('found', 'false');
              return;
            }

            const pr = prs[0];
            core.setOutput('found', 'true');
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_branch', pr.head.ref);
            core.setOutput('pr_sha', pr.head.sha);
            console.log(`Found PR #${pr.number} on branch ${pr.head.ref}`);

      - name: Check for REVIEW_INSTRUCTIONS.md
        if: steps.pr.outputs.found == 'true'
        id: check_instructions
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          PR_BRANCH: ${{ steps.pr.outputs.pr_branch }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const branch = process.env.PR_BRANCH;

            try {
              // Check if REVIEW_INSTRUCTIONS.md exists in the PR branch
              await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: 'REVIEW_INSTRUCTIONS.md',
                ref: branch
              });

              console.log('REVIEW_INSTRUCTIONS.md found - issues were detected');
              core.setOutput('has_issues', 'true');
            } catch (error) {
              if (error.status === 404) {
                console.log('No REVIEW_INSTRUCTIONS.md - PR was approved or no issues');
                core.setOutput('has_issues', 'false');
              } else {
                throw error;
              }
            }

      - name: Get latest Gemini review comment
        if: steps.pr.outputs.found == 'true' && steps.check_instructions.outputs.has_issues == 'true'
        id: review
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);

            // Get comments on the PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            // Find the latest Gemini review comment
            const geminiComments = comments.filter(c =>
              c.body && c.body.includes('## ðŸ¤– Gemini PR Review')
            );

            if (geminiComments.length === 0) {
              console.log('No Gemini review comment found');
              core.setOutput('found_review', 'false');
              return;
            }

            // Get the most recent one
            const latestReview = geminiComments[geminiComments.length - 1];
            core.setOutput('found_review', 'true');
            core.setOutput('review_id', latestReview.id);

            // Extract the suggestions summary for display
            const reviewBody = latestReview.body;
            core.setOutput('review_summary', reviewBody.substring(0, 2000));
            console.log(`Found Gemini review comment ID: ${latestReview.id}`);

      - name: Check for existing Claude Code prompt
        if: steps.pr.outputs.found == 'true' && steps.check_instructions.outputs.has_issues == 'true' && steps.review.outputs.found_review == 'true'
        id: check_prompt
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          REVIEW_ID: ${{ steps.review.outputs.review_id }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);

            // Get comments on the PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            // Check if we already posted a Claude Code prompt after the latest Gemini review
            const geminiReviewId = parseInt(process.env.REVIEW_ID);
            const geminiReviewIndex = comments.findIndex(c => c.id === geminiReviewId);

            // Look for Claude Code prompt after the Gemini review
            const promptAfterReview = comments.slice(geminiReviewIndex + 1).find(c =>
              c.body && c.body.includes('## ðŸ”„ Claude Code Integration')
            );

            if (promptAfterReview) {
              console.log('Claude Code prompt already exists for this review');
              core.setOutput('exists', 'true');
            } else {
              console.log('No Claude Code prompt found - will create one');
              core.setOutput('exists', 'false');
            }

      - name: Post Claude Code prompt
        if: >
          steps.pr.outputs.found == 'true' &&
          steps.check_instructions.outputs.has_issues == 'true' &&
          steps.review.outputs.found_review == 'true' &&
          steps.check_prompt.outputs.exists == 'false'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          REVIEW_ID: ${{ steps.review.outputs.review_id }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const reviewId = parseInt(process.env.REVIEW_ID);

            const promptBody = [
              '## ðŸ”„ Claude Code Integration',
              '',
              'Gemini has reviewed this PR and found issues to address. How would you like to proceed?',
              '',
              '**Options:**',
              '- Comment `/accept` to **accept and implement all suggestions**',
              '- Reply with custom instructions to modify what gets implemented',
              '',
              '**Example custom instructions:**',
              '- `Ignore suggestion #2, implement the rest`',
              '- `Implement security fixes only, skip style suggestions`',
              '- `Use parameterized queries instead of escaping for the SQL issue`',
              '',
              '---',
              '',
              '> **Note:** After commenting, Claude Code will implement changes and push to this branch.',
              '> The review cycle continues until you merge.',
              '',
              `<!-- claude-code-prompt:${reviewId} -->`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: promptBody
            });

            console.log(`Posted Claude Code prompt on PR #${prNumber}`);
