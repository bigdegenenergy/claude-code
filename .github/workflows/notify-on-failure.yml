name: Notify on Failure

on:
  workflow_run:
    workflows: ["CI", "Security Scan"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Send Slack Notification
        continue-on-error: true
        if: ${{ vars.ENABLE_SLACK == 'true' || secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [{
                "color": "#FF0000",
                "title": "Workflow Failed: ${{ github.event.workflow_run.name }}",
                "text": "Repository: ${{ github.repository }}\nBranch: ${{ github.event.workflow_run.head_branch }}",
                "footer": "Claude Code CI"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Telegram Notification
        continue-on-error: true
        if: ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=Markdown" \
            -d "text=ðŸ”´ *Workflow Failed*%0A%0A*Workflow:* ${{ github.event.workflow_run.name }}%0A*Repository:* ${{ github.repository }}%0A*Branch:* ${{ github.event.workflow_run.head_branch }}%0A%0A[View Run](${{ github.event.workflow_run.html_url }})"

      - name: Send Discord Notification
        continue-on-error: true
        if: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"embeds": [{"title": "Workflow Failed: ${{ github.event.workflow_run.name }}", "description": "Repository: ${{ github.repository }}\nBranch: ${{ github.event.workflow_run.head_branch }}", "color": 16711680, "url": "${{ github.event.workflow_run.html_url }}"}]}'

      - name: Send ntfy Notification
        continue-on-error: true
        if: ${{ secrets.NTFY_TOPIC != '' }}
        run: |
          curl -s -X POST "${{ secrets.NTFY_SERVER || 'https://ntfy.sh' }}/${{ secrets.NTFY_TOPIC }}" \
            -H "Title: Workflow Failed: ${{ github.event.workflow_run.name }}" \
            -H "Priority: 5" \
            -H "Tags: x" \
            -H "Click: ${{ github.event.workflow_run.html_url }}" \
            -d "Repository: ${{ github.repository }} | Branch: ${{ github.event.workflow_run.head_branch }}"

      - name: Send Email Notification
        continue-on-error: true
        if: ${{ secrets.SMTP_HOST != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT || 587 }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "[FAILED] ${{ github.event.workflow_run.name }} - ${{ github.repository }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM || secrets.SMTP_USER }}
          body: |
            Workflow Failed!

            Workflow: ${{ github.event.workflow_run.name }}
            Repository: ${{ github.repository }}
            Branch: ${{ github.event.workflow_run.head_branch }}
            Commit: ${{ github.event.workflow_run.head_sha }}

            View the run: ${{ github.event.workflow_run.html_url }}

      - name: Send Custom Webhook
        continue-on-error: true
        if: ${{ secrets.CUSTOM_WEBHOOK_URL != '' }}
        run: |
          curl -s -X POST "${{ secrets.CUSTOM_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"event": "workflow_failed", "workflow": "${{ github.event.workflow_run.name }}", "repository": "${{ github.repository }}", "branch": "${{ github.event.workflow_run.head_branch }}", "url": "${{ github.event.workflow_run.html_url }}"}'

      - name: Log notification status
        run: echo "Notification job completed. Notifications sent to configured platforms."
